# 決算スイングトレード戦略バックテスト

*他の言語で読む: [English](README.md), [日本語](README_ja.md)*

決算サプライズを利用したスイングトレード戦略のバックテストシステム。中小型株に特化し、EODHD APIを使用してリアルタイムデータに基づく取引シミュレーションを実行します。

## 🚀 クイックスタート

### 前提条件

- Python 3.11以上
- [EODHD API](https://eodhistoricaldata.com/)のAPIキー

### インストール

```bash
# リポジトリをクローン
git clone https://github.com/tradermonty/earnings-trade-backtest.git
cd earnings-trade-backtest

# 仮想環境を作成・アクティベート
python3.11 -m venv venv
source venv/bin/activate  # macOS/Linux
# または
venv\Scripts\activate     # Windows

# 依存関係をインストール
pip install -r requirements.txt
```

### 環境設定

`.env` ファイルを作成してAPIキーを設定：

```env
EODHD_API_KEY=your_api_key_here
```

### 基本的な実行

```bash
# デフォルト設定で実行（過去1ヶ月間）
python main.py

# 特定の期間を指定して実行
python main.py --start_date 2025-01-01 --end_date 2025-06-30

# ヘルプを表示
python main.py --help
```

## 📁 プロジェクト構成

```
earnings-trade-backtest/
├── src/                           # コアソースコードモジュール
│   ├── data_fetcher.py           # EODHD APIデータ取得
│   ├── data_filter.py            # 決算・技術的フィルター
│   ├── trade_executor.py         # 取引実行シミュレーション
│   ├── risk_manager.py           # リスク管理システム
│   ├── analysis_engine.py        # 高度なパフォーマンス分析
│   ├── report_generator.py       # 強化されたHTML/CSVレポート生成
│   ├── metrics_calculator.py     # 取引メトリクス計算
│   ├── config.py                 # 設定管理
│   └── main.py                   # モジュール式メイン実行
├── tests/                         # 包括的テストスイート
├── reports/                       # 生成された分析レポート（実行後）
├── docs/                          # ドキュメント・スクリーンショット
├── main.py                        # メインエントリーポイント（推奨）
├── requirements.txt               # Python依存関係
├── CLAUDE.md                     # Claude向けドキュメント
├── README.md                     # 英語版ドキュメント
├── README_ja.md                  # このファイル
├── .gitignore                    # Git除外設定
├── docs/                         # ドキュメント・スクリーンショット
└── reports/                      # 生成される分析レポート（実行後）
    ├── *.html                    # インタラクティブレポート
    └── *.csv                     # 取引データ
```

## 🎯 戦略の概要

### 1. エントリー条件
- **決算サプライズ**: 5%以上の予想超過
- **ギャップアップ**: 決算発表後の株価上昇
- **市場キャップ**: 中小型株（$300M-$10B）
- **出来高**: 通常の2倍以上

### 2. エグジット条件
- **ストップロス**: 6%の損失で自動売却
- **トレーリングストップ**: 21日移動平均線を下回ったら売却
- **最大保有期間**: 50日

### 3. リスク管理
- **ポジションサイズ**: 資本の6%
- **マージン制御**: 最大1.5倍レバレッジ（総ポジションvs資本）
- **同時保有**: 最大10銘柄
- **セクター分散**: 各セクター最大30%

## 📈 レポート出力

バックテスト実行後、以下の分析データが出力されます：

- **月別パフォーマンス**: 各月の損益推移
- **セクター別分析**: 業界別のパフォーマンス比較
- **取引統計**: 勝率、プロフィットファクター、ドローダウン等
- **リスク指標**: 最大損失、ボラティリティ分析

## 🔧 詳細なパラメータ設定

### コマンドライン引数

#### 基本設定
```bash
# 分析期間の指定
--start_date 2025-01-01     # 開始日（YYYY-MM-DD形式）
--end_date 2025-06-30       # 終了日（YYYY-MM-DD形式）

# 資金設定
--initial_capital 100000    # 初期資金（デフォルト: $100,000）
--position_size 6           # ポジションサイズ％（デフォルト: 6%）
```

#### リスク管理設定
```bash
# ストップロス・利確設定
--stop_loss 6               # ストップロス率％（デフォルト: 6%）
--trail_stop_ma 21          # トレーリングストップMA期間（デフォルト: 21日）
--max_holding_days 90       # 最大保有期間（デフォルト: 90日）
--risk_limit 6              # リスク管理制限％（デフォルト: 6%）
--margin_ratio 1.5          # 最大ポジション対資本率（デフォルト: 1.5倍）

# 取引コスト
--slippage 0.3              # スリッページ％（デフォルト: 0.3%）
```

#### 対象銘柄フィルター
```bash
# 銘柄フィルター
--sp500_only                # S&P500銘柄のみ対象
--no_mid_small_only         # 中小型株制限を解除（デフォルト: 中小型株のみ）

# 決算前株価条件
--pre_earnings_change -10   # 決算前20日間の株価変化率閾値％（デフォルト: 0%）
```

#### その他の設定
```bash
# 利確戦略
--no_partial_profit         # 初日部分利確を無効化（デフォルト: 有効）

# 出力言語
--language ja               # レポート言語（ja/en、デフォルト: en）
```

### 実践的な使用例

#### 1. 保守的な設定（低リスク）
```bash
python main.py \
  --start_date 2025-01-01 \
  --end_date 2025-06-30 \
  --stop_loss 4 \
  --position_size 4 \
  --max_holding_days 60 \
  --margin_ratio 1.2 \
  --sp500_only
```

#### 2. アグレッシブな設定（高リターン志向）
```bash
python main.py \
  --start_date 2025-01-01 \
  --end_date 2025-06-30 \
  --stop_loss 8 \
  --position_size 8 \
  --max_holding_days 120 \
  --margin_ratio 2.0 \
  --no_mid_small_only
```

#### 3. 中小型株特化・長期保有戦略
```bash
python main.py \
  --start_date 2025-01-01 \
  --end_date 2025-06-30 \
  --stop_loss 6 \
  --trail_stop_ma 50 \
  --max_holding_days 180 \
  --margin_ratio 1.5 \
  --pre_earnings_change -20
```

### 全パラメータの詳細説明

#### 基本設定パラメータ

| パラメータ | デフォルト値 | 効果・説明 | 推奨値 | 注意点 |
|-----------|-------------|-----------|--------|--------|
| `start_date` | 1ヶ月前 | バックテスト開始日 | 過去の日付 | YYYY-MM-DD形式で指定 |
| `end_date` | 今日 | バックテスト終了日 | 過去の日付 | 未来日は自動調整される |
| `initial_capital` | 100000 | 初期資金額（USD） | 10000-1000000 | 小さすぎると分散効果なし |
| `language` | 'en' | レポート言語 | 'en'/'ja' | 日本語は'ja'を指定 |

#### エントリー条件パラメータ

| パラメータ | デフォルト値 | 効果・説明 | 推奨値 | 注意点 |
|-----------|-------------|-----------|--------|--------|
| `pre_earnings_change` | 0% | 決算前20日間の株価変化率閾値 | -20-0% | 負の値で下落後の反発狙い |
| **内部固定値** | 5% | 決算サプライズ閾値 | - | コード内で固定、変更は要開発 |
| **内部固定値** | 0% | ギャップアップ閾値 | - | 決算後の初動を捉える |
| **内部固定値** | $10 | 最低株価 | - | ペニーストック除外 |
| **内部固定値** | 200k株 | 最低平均出来高（20日） | - | 流動性確保 |

#### ポジション管理パラメータ

| パラメータ | デフォルト値 | 効果・説明 | 推奨値 | 注意点 |
|-----------|-------------|-----------|--------|--------|
| `position_size` | 6% | 1取引あたりの資金割合 | 4-8% | 高いとリスク増、低いと収益性低下 |
| `margin_ratio` | 1.5 | 最大ポジション対資本率 | 1.2-2.0 | レバレッジ制御、過度な暴露を防止 |
| `slippage` | 0.3% | 取引コスト（スリッページ） | 0.1-0.5% | リアルな取引環境を反映 |
| **内部固定値** | 10銘柄 | 最大同時保有数 | - | 過度な分散を防ぐ |

#### エグジット条件パラメータ

| パラメータ | デフォルト値 | 効果・説明 | 推奨値 | 注意点 |
|-----------|-------------|-----------|--------|--------|
| `stop_loss` | 6% | 損失制限率 | 4-8% | 低すぎるとノイズで損切り頻発 |
| `trail_stop_ma` | 21日 | トレーリングストップMA期間 | 21-50日 | 短すぎると早期売却、長すぎると含み益減少 |
| `max_holding_days` | 90日 | 最大保有期間 | 60-180日 | 市場サイクルとの関係を考慮 |
| `partial_profit` | True | 初日部分利確の有効化 | True/False | 35%ポジションを8%利益で売却 |

#### リスク管理パラメータ

| パラメータ | デフォルト値 | 効果・説明 | 推奨値 | 注意点 |
|-----------|-------------|-----------|--------|--------|
| `risk_limit` | 6% | 累積損失制限（新規取引停止） | 5-10% | 連続損失時の防護装置 |

#### 銘柄フィルターパラメータ

| パラメータ | デフォルト値 | 効果・説明 | 推奨値 | 備考 |
|-----------|-------------|-----------|--------|------|
| `sp500_only` | False | S&P500銘柄のみ対象 | - | 大型株中心、安定志向 |
| `mid_small_only` | True | 中小型株のみ対象 | - | S&P400/600、成長志向 |
| `no_mid_small_only` | False | 中小型株制限解除 | - | 全市場対象 |

### エグジット条件の詳細

#### 1. 部分利確システム（partial_profit=True時）
```
エントリー後1日目：
├─ 8%以上の利益 → 35%のポジション売却
└─ 8%未満の利益 → ポジション維持
```

#### 2. トレーリングストップ
```
株価が21日移動平均線を下回る
└─ 翌日寄り付きで全ポジション売却
```

#### 3. ストップロス
```
エントリー価格から6%下落
└─ 即座に全ポジション売却
```

#### 4. 最大保有期間
```
90日経過
└─ 強制的に全ポジション売却
```

### パラメータチューニングのコツ

#### 保守的設定（リスク重視）
- `stop_loss`: 4%
- `position_size`: 4%
- `trail_stop_ma`: 15日
- `max_holding_days`: 60日

#### アグレッシブ設定（リターン重視）
- `stop_loss`: 8%
- `position_size`: 8%
- `trail_stop_ma`: 50日
- `max_holding_days`: 180日

#### 中小型株特化設定
- `mid_small_only`: True
- `pre_earnings_change`: -15%
- `trail_stop_ma`: 30日

## 📊 結果の確認方法

### 生成されるファイル

バックテスト実行後、`reports/` ディレクトリに以下のファイルが自動生成されます：

```
reports/
├── earnings_backtest_report_2025-01-01_2025-06-30.html     # メインレポート
└── earnings_backtest_2025-01-01_2025-06-30.csv             # 取引データ
```

### 1. HTMLインタラクティブレポート

メインレポート（`.html`）にはダークテーマの美しいチャートが含まれます：

![パフォーマンス概要](docs/backtest-report-1.png)
*主要指標とパフォーマンス概要のダッシュボード*

![月次分析](docs/backtest-report-2.png)
*月次パフォーマンスヒートマップとセクター分析*

![詳細チャート](docs/backtest-report-3.png)
*詳細なテクニカル分析と取引内訳*

#### 📈 含まれるチャート
- **資産推移グラフ**: 時系列での資産増減
- **月別パフォーマンス**: 各月の損益
- **セクター別分析**: 業界別収益性
- **出口理由分析**: 売却理由の内訳
- **勝率・損益比分析**: 取引パフォーマンス統計

#### 📊 主要指標
- **総リターン**: 期間全体の収益率
- **勝率**: 利益が出たトレードの割合
- **プロフィットファクター**: 利益÷損失の比率
- **最大ドローダウン**: 最大資産減少額
- **シャープレシオ**: リスク調整後収益

### 2. CSVデータファイル

#### 取引データ（`.csv`）の列：
```
ticker          # ティッカーシンボル
entry_date      # エントリー日
exit_date       # エグジット日
entry_price     # エントリー価格
exit_price      # エグジット価格
shares          # 株数
pnl             # 損益額
pnl_rate        # 損益率
exit_reason     # 売却理由
sector          # セクター
holding_days    # 保有期間
```

### 3. レポートの見方

#### パフォーマンス評価基準
- **プロフィットファクター > 1.5**: 良好
- **勝率 > 45%**: 優秀
- **最大ドローダウン < 20%**: 許容範囲
- **シャープレシオ > 1.0**: 優秀

#### セクター分析の活用
- 特定業界への集中リスクを確認
- 業界ローテーションの効果を分析
- ポートフォリオ分散の参考にする

### 4. 実行時の出力例

```bash
$ python main.py --start_date 2025-01-01 --end_date 2025-06-30

=== Earnings Trade Backtest (Refactored Version) ===
期間: 2025-01-01 から 2025-06-30
初期資金: $100,000
ポジションサイズ: 6%
ストップロス: 6%
マージン倍率制限: 1.5倍
対象: 中型・小型株 (S&P 400/600)

1. 決算データの取得を開始...
2. 第1段階フィルタリング: 決算サプライズ ≥ 5%
3. 第2段階フィルタリング: 技術的条件
4. バックテストの実行中...
5. バックテスト完了
6. 分析チャートを生成中...
7. レポートを生成中...

HTMLレポートを生成しました: reports/earnings_backtest_report_2025-01-01_2025-06-30.html
CSVレポートを生成しました: reports/earnings_backtest_2025-01-01_2025-06-30.csv
```

### 5. トラブルシューティング

#### よくあるエラーと対処法

```bash
# APIキーエラー
"ValueError: .envファイルにEODHD_API_KEYが設定されていません"
→ .envファイルの設定を確認

# 日付エラー
"警告: 終了日が未来の日付です"
→ 適切な過去の日付を指定

# データ不足エラー
"Not enough data for analysis"
→ より長い期間を指定するか、フィルター条件を緩和
```

#### パフォーマンス最適化
```bash
# 高速実行（短期間分析）
python main.py --start_date 2025-06-01 --end_date 2025-06-30

# 詳細分析（長期間、要時間）
python main.py --start_date 2024-01-01 --end_date 2025-06-30
```

## ⚠️ 重要な注意事項

### バックテストについて
- **バックテスト結果は過去データに基づくシミュレーション**です
- **実際の取引環境とは異なる場合**があります（スリッページ、流動性等）
- **将来のパフォーマンスを保証するものではありません**

### 投資判断について
- このシステムは**研究・教育目的**で提供されています
- 実際の投資判断は**必ずご自身の責任**で行ってください
- **専門家への相談**を推奨します

### システムの制限
- 市場の急変時には想定通りに動作しない可能性があります
- APIの制限や障害により取引機会を逃す可能性があります
- 戦略は定期的な見直しと調整が必要です

## 🤝 貢献

バグ報告、機能リクエスト、改善提案は Issues からお気軽にお寄せください。

## 📄 ライセンス

このプロジェクトはMITライセンスの下で公開されています。

## 📚 戦略の理論的背景

この決算スイングトレード戦略は、以下の学術研究と実践的手法に基づいています：

### 学術的基盤

**"Post-Earnings-Announcement Drift: Delayed Price Response or Risk Premium?"**  
*Victor L. Bernard and Jacob K. Thomas*

- **概要**: 決算発表後の株価の継続的な方向性（Post-Earnings Announcement Drift, PEAD）を発見
- **主要発見**: 好決算銘柄は発表後も数日〜数週間にわたり上昇し続ける傾向
- **理論**: 市場参加者の情報処理能力の限界により、決算内容が株価に完全に反映されるまで時間がかかる
- **実装**: 本戦略の5%サプライズ閾値とスイング期間（平均20日保有）の根拠

### 実践的手法

**"How to master a setup: Episodic Pivots"**  
*Qullamaggie Trading*  
https://qullamaggie.com/how-to-master-a-setup-episodic-pivots/

- **概要**: 決算などのカタリストを利用したモメンタム取引手法
- **主要概念**:
  - **Episodic Pivot**: 決算発表などの特定イベントを契機とした株価の方向転換
  - **Base Building**: 決算前の株価調整期間の重要性
  - **Volume Confirmation**: 出来高急増による方向性の確認
- **実装**: 本戦略のギャップアップフィルター、出来高分析、トレーリングストップの設計根拠

### 戦略統合のポイント

1. **学術的根拠（PEAD）**: 決算サプライズ後の継続的上昇傾向
2. **実践的手法（Episodic Pivots）**: 具体的なエントリー・エグジット条件
3. **リスク管理**: 両方のアプローチを統合した包括的な損失制限システム

## 📚 関連ドキュメント

- [システム詳細ドキュメント](CLAUDE.md)
- [English Documentation](README.md)

---

**免責事項**: このソフトウェアとその分析結果は情報提供のみを目的としており、投資アドバイスではありません。投資判断はご自身の責任で行ってください。