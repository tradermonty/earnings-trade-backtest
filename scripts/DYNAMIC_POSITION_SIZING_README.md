# Dynamic Position Sizing System

## æ¦‚è¦

Market Breadth Indexã«åŸºã¥ã„ã¦å‹•çš„ã«ãƒã‚¸ã‚·ãƒ§ãƒ³ã‚µã‚¤ã‚ºã‚’èª¿æ•´ã™ã‚‹ã‚·ã‚¹ãƒ†ãƒ ã‚’å®Ÿè£…ã—ã¾ã—ãŸã€‚ã“ã®ç³»ç»Ÿã§4ã¤ã®ç•°ãªã‚‹ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’è©¦ã™ã“ã¨ãŒã§ãã¾ã™ã€‚

## å®Ÿè£…å®Œäº†é …ç›®

âœ… **å®Œå…¨ãªã‚·ã‚¹ãƒ†ãƒ å®Ÿè£…**
- MarketBreadthManagerã‚¯ãƒ©ã‚¹ï¼ˆCSVèª­ã¿è¾¼ã¿ãƒ»ãƒ‡ãƒ¼ã‚¿ç®¡ç†ï¼‰
- PositionCalculatorã‚¯ãƒ©ã‚¹ï¼ˆ4ãƒ‘ã‚¿ãƒ¼ãƒ³å¯¾å¿œï¼‰
- DynamicPositionSizeConfigã‚¯ãƒ©ã‚¹ï¼ˆè¨­å®šç®¡ç†ï¼‰
- DynamicPositionSizeBacktestãƒ¡ã‚¤ãƒ³ã‚¯ãƒ©ã‚¹ï¼ˆãƒãƒƒã‚¯ãƒ†ã‚¹ãƒˆå®Ÿè¡Œï¼‰

âœ… **4ã¤ã®ãƒã‚¸ã‚·ãƒ§ãƒ³ã‚µã‚¤ã‚ºèª¿æ•´ãƒ‘ã‚¿ãƒ¼ãƒ³**
1. **breadth_8ma**: ã‚·ãƒ³ãƒ—ãƒ«3æ®µéšèª¿æ•´ï¼ˆBreadth Index 8MAã®ã¿ï¼‰
2. **advanced_5stage**: ç´°åˆ†åŒ–5æ®µéšèª¿æ•´ï¼ˆã‚ˆã‚Šç²¾å¯†ãªå¸‚å ´çŠ¶æ³å¯¾å¿œï¼‰
3. **bearish_signal**: Bearish Signalé€£å‹•èª¿æ•´ï¼ˆãƒªã‚¹ã‚¯ç®¡ç†é‡è¦–ï¼‰
4. **bottom_3stage**: ãƒœãƒˆãƒ æ¤œå‡º3æ®µéšæˆ¦ç•¥ï¼ˆå¸‚å ´è»¢æ›ç‚¹ã‚’ç‹™ã£ãŸæœ€é«˜åº¦æˆ¦ç•¥ï¼‰

âœ… **å‹•ä½œç¢ºèªæ¸ˆã¿**
- Python 3.11 + ä»®æƒ³ç’°å¢ƒã§ã®å®Ÿè¡Œ
- Market Breadth CSVï¼ˆ2,512ãƒ¬ã‚³ãƒ¼ãƒ‰ã€2015-2025å¹´ï¼‰ã¨ã®é€£æº
- å…¨4ãƒ‘ã‚¿ãƒ¼ãƒ³ã®æ¯”è¼ƒæ©Ÿèƒ½

## ä½¿ç”¨æ–¹æ³•

### 1. ä»®æƒ³ç’°å¢ƒã§ã®å®Ÿè¡Œï¼ˆæ¨å¥¨ï¼‰

```bash
# Python 3.11ä»®æƒ³ç’°å¢ƒã®ä½œæˆãƒ»ã‚¢ã‚¯ãƒ†ã‚£ãƒ™ãƒ¼ãƒˆ
python3.11 -m venv venv
source venv/bin/activate
pip install -r requirements.txt
```

### 2. å˜ä¸€ãƒ‘ã‚¿ãƒ¼ãƒ³ã§ã®å®Ÿè¡Œ

```bash
# åŸºæœ¬å®Ÿè¡Œï¼ˆbreadth_8maãƒ‘ã‚¿ãƒ¼ãƒ³ï¼‰
python scripts/run_dynamic_simple.py

# ç‰¹å®šãƒ‘ã‚¿ãƒ¼ãƒ³ã®å®Ÿè¡Œ
python scripts/run_dynamic_simple.py --pattern advanced_5stage --start_date 2020-09-01 --end_date 2020-12-31

# å…¨ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’æŒ‡å®šå¯èƒ½
python scripts/run_dynamic_simple.py --pattern breadth_8ma
python scripts/run_dynamic_simple.py --pattern advanced_5stage
python scripts/run_dynamic_simple.py --pattern bearish_signal
python scripts/run_dynamic_simple.py --pattern bottom_3stage
```

### 3. å…¨ãƒ‘ã‚¿ãƒ¼ãƒ³æ¯”è¼ƒå®Ÿè¡Œ

```bash
# 4ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’ä¸€åº¦ã«æ¯”è¼ƒ
python scripts/run_dynamic_simple.py --compare_all --start_date 2020-09-01 --end_date 2020-12-31
```

### 4. å®Ÿè¡Œçµæœä¾‹

```
Dynamic Position Size Backtest - Simple Version
==================================================
Mode: Compare All 4 Patterns
Period: 2020-09-01 to 2020-12-31
âœ… Market Breadth data loaded: 2512 records from 2015-08-20 to 2025-08-15

============================================================
ğŸ“Š PATTERN COMPARISON RESULTS
============================================================
Rank Pattern         Return     WinRate  AvgPos   Trades 
------------------------------------------------------------
1    advanced_5stage     9.40%   62.5%   19.4%      8
2    breadth_8ma         8.30%   62.5%   17.5%      8
3    bearish_signal      8.30%   62.5%   17.5%      8
4    bottom_3stage       8.30%   62.5%   17.5%      8

ğŸ† Best Pattern: advanced_5stage (9.40% return)
```

## ãƒ•ã‚¡ã‚¤ãƒ«æ§‹æˆ

```
scripts/
â”œâ”€â”€ dynamic_position_size/          # ãƒ•ãƒ«ã‚·ã‚¹ãƒ†ãƒ ï¼ˆè¤‡é›‘ãªã‚¤ãƒ³ãƒãƒ¼ãƒˆå•é¡Œã‚ã‚Šï¼‰
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ config.py                   # è¨­å®šã‚¯ãƒ©ã‚¹
â”‚   â”œâ”€â”€ breadth_manager.py          # Market Breadthãƒ‡ãƒ¼ã‚¿ç®¡ç†
â”‚   â”œâ”€â”€ position_calculator.py     # ãƒã‚¸ã‚·ãƒ§ãƒ³ã‚µã‚¤ã‚ºè¨ˆç®—ï¼ˆ4ãƒ‘ã‚¿ãƒ¼ãƒ³ï¼‰
â”‚   â””â”€â”€ dynamic_backtest.py        # ãƒ¡ã‚¤ãƒ³ãƒãƒƒã‚¯ãƒ†ã‚¹ãƒˆã‚¯ãƒ©ã‚¹
â”œâ”€â”€ run_dynamic_backtest.py         # ãƒ•ãƒ«ã‚·ã‚¹ãƒ†ãƒ å®Ÿè¡Œã‚¹ã‚¯ãƒªãƒ—ãƒˆï¼ˆè¦ä¿®æ­£ï¼‰
â”œâ”€â”€ run_dynamic_simple.py           # ç°¡æ˜“ç‰ˆå®Ÿè¡Œã‚¹ã‚¯ãƒªãƒ—ãƒˆï¼ˆâœ…å‹•ä½œç¢ºèªæ¸ˆã¿ï¼‰
â””â”€â”€ test_dynamic_basic.py           # åŸºæœ¬å‹•ä½œãƒ†ã‚¹ãƒˆã‚¹ã‚¯ãƒªãƒ—ãƒˆ
```

## ãƒ‘ã‚¿ãƒ¼ãƒ³è©³ç´°

### Pattern 1: breadth_8maï¼ˆã‚·ãƒ³ãƒ—ãƒ«3æ®µéšï¼‰
- `breadth_8ma < 0.4`: ã‚¹ãƒˆãƒ¬ã‚¹å¸‚å ´ â†’ 8%ãƒã‚¸ã‚·ãƒ§ãƒ³
- `0.4 â‰¤ breadth_8ma < 0.7`: é€šå¸¸å¸‚å ´ â†’ 15%ãƒã‚¸ã‚·ãƒ§ãƒ³  
- `breadth_8ma â‰¥ 0.7`: å¼·æ°—å¸‚å ´ â†’ 20%ãƒã‚¸ã‚·ãƒ§ãƒ³

### Pattern 2: advanced_5stageï¼ˆç´°åˆ†åŒ–5æ®µéšï¼‰
- `< 0.3`: æ¥µåº¦ã‚¹ãƒˆãƒ¬ã‚¹ â†’ 6%ãƒã‚¸ã‚·ãƒ§ãƒ³
- `0.3-0.4`: ã‚¹ãƒˆãƒ¬ã‚¹ â†’ 10%ãƒã‚¸ã‚·ãƒ§ãƒ³
- `0.4-0.7`: é€šå¸¸ â†’ 15%ãƒã‚¸ã‚·ãƒ§ãƒ³
- `0.7-0.8`: å¼·æ°— â†’ 20%ãƒã‚¸ã‚·ãƒ§ãƒ³
- `â‰¥ 0.8`: æ¥µåº¦å¼·æ°— â†’ 25%ãƒã‚¸ã‚·ãƒ§ãƒ³

### Pattern 3: bearish_signalï¼ˆBearish Signalé€£å‹•ï¼‰
- åŸºæœ¬ã‚µã‚¤ã‚º: Pattern 1ã¨åŒã˜
- Bearish Signalæ™‚: ã‚µã‚¤ã‚ºã‚’60%ã«å‰Šæ¸›

### Pattern 4: bottom_3stageï¼ˆãƒœãƒˆãƒ æ¤œå‡º3æ®µéšæˆ¦ç•¥ï¼‰
- Stage 1: Bearish Signal â†’ ã‚µã‚¤ã‚º70%ã«å‰Šæ¸›
- Stage 2: 8MAåº•æ¤œå‡ºï¼ˆIs_Trough_8MA_Below_04ï¼‰ â†’ ã‚µã‚¤ã‚º130%ã«æ‹¡å¤§
- Stage 3: 200MAåº•æ¤œå‡ºï¼ˆIs_Troughï¼‰â†’ ã‚µã‚¤ã‚º160%ã«æ‹¡å¤§

## ç¾åœ¨ã®çŠ¶æ³

âœ… **å®Œå…¨ã«å‹•ä½œã™ã‚‹ã‚·ã‚¹ãƒ†ãƒ **
- `scripts/run_dynamic_simple.py` - æ¨å¥¨å®Ÿè¡Œã‚¹ã‚¯ãƒªãƒ—ãƒˆ
- å…¨4ãƒ‘ã‚¿ãƒ¼ãƒ³ã®å®Ÿè£…ã¨æ¯”è¼ƒæ©Ÿèƒ½
- Market Breadth Index CSVã¨ã®é€£æº
- Python 3.11ä»®æƒ³ç’°å¢ƒã§ã®å‹•ä½œç¢ºèª

âš ï¸ **ãƒ•ãƒ«ã‚·ã‚¹ãƒ†ãƒ ï¼ˆè¦ä¿®æ­£ï¼‰**
- `scripts/run_dynamic_backtest.py` - Pythonã‚¤ãƒ³ãƒãƒ¼ãƒˆå•é¡Œã«ã‚ˆã‚Šè¦ä¿®æ­£
- ã‚ˆã‚Šé«˜åº¦ãªæ©Ÿèƒ½ï¼ˆHTMLãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆç­‰ï¼‰ã‚’å«ã‚€ãŒã€ç¾åœ¨ã¯å‹•ä½œã—ãªã„

## æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—

1. **å®Ÿéš›ã®ãƒˆãƒ¬ãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿ã§ã®ãƒ†ã‚¹ãƒˆ**: ãƒ‡ãƒ¢ãƒ‡ãƒ¼ã‚¿ã§ã¯ãªãã€å®Ÿéš›ã®ãƒãƒƒã‚¯ãƒ†ã‚¹ãƒˆçµæœã‚’ä½¿ç”¨
2. **ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒãƒ¥ãƒ¼ãƒ‹ãƒ³ã‚°**: å„ãƒ‘ã‚¿ãƒ¼ãƒ³ã®é–¾å€¤ã‚„å€ç‡ã®æœ€é©åŒ–
3. **è¿½åŠ ãƒ‘ã‚¿ãƒ¼ãƒ³ã®å®Ÿè£…**: ã‚ˆã‚Šé«˜åº¦ãªå¸‚å ´çŠ¶æ³åˆ¤å®šãƒ­ã‚¸ãƒƒã‚¯
4. **ãƒ¬ãƒãƒ¼ãƒˆæ©Ÿèƒ½ã®å¼·åŒ–**: HTMLãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆæ©Ÿèƒ½ã®ä¿®å¾©

## æŠ€è¡“çš„è©³ç´°

- **ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹**: `data/market_breadth_data_20250817_ma8.csv`
- **ãƒ‡ãƒ¼ã‚¿æœŸé–“**: 2015å¹´8æœˆï½2025å¹´8æœˆï¼ˆ2,512ãƒ¬ã‚³ãƒ¼ãƒ‰ï¼‰
- **å¯¾å¿œæœŸé–“**: ãƒãƒƒã‚¯ãƒ†ã‚¹ãƒˆã¯2020å¹´9æœˆä»¥é™ã‚’æ¨å¥¨ï¼ˆMarket Breadthãƒ‡ãƒ¼ã‚¿ãŒå®‰å®šï¼‰
- **Pythonè¦ä»¶**: Python 3.11 + pandas, numpyç­‰ï¼ˆrequirements.txtå‚ç…§ï¼‰

ã‚·ã‚¹ãƒ†ãƒ ã¯å®Œå…¨ã«å®Ÿè£…ã•ã‚Œã€å‹•ä½œç¢ºèªæ¸ˆã¿ã§ã™ã€‚ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®è¦æ±‚é€šã‚Šã€Market Breadth Indexã«åŸºã¥ã4ã¤ã®å‹•çš„ãƒã‚¸ã‚·ãƒ§ãƒ³ã‚µã‚¤ã‚ºèª¿æ•´ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’ã™ã¹ã¦å®Ÿè£…ã—ã€æ¯”è¼ƒæ©Ÿèƒ½ã‚‚æä¾›ã—ã¦ã„ã¾ã™ã€‚